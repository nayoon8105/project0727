<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cafe">
	<sql id="cafeColumn">
		num, writer, title , content, viewCount, TO_CHAR(regdate,'YYYY.MM.DD AM HH:MI') AS regdate
	</sql>
	
	<insert id="insert" parameterType="cafeDto">
		INSERT INTO board_cafe
		(num, writer, title, content, viewCount, regdate)
		VALUES(board_cafe_seq.NEXTVAL, #{writer}, #{title}, #{content}, #{viewCount}, SYSDATE)
	</insert>
	<!-- 
		mybatis의 장점
		: 복잡한 sql 문을 xml 문서로 작성하는게 더 편함, #{변수명}을 자동으로 바인딩 해 줌,
		  resultType 명시하면 알아서 select 결과를 데이터형에 맞게 반환,
		  다이나믹 쿼리를 지원해 줌
	  -->
	<delete id="delete" parameterType="int">
		DELETE FROM board_cafe
		WHERE num=#{num}
	</delete>
	
	<update id="update" parameterType="cafeDto">
		UPDATE board_cafe
		SET title=#{title}, content=#{content}
		WHERE num=#{num}
	</update>
	
	<select id="getCount" parameterType="cafeDto" resultType="int">
		SELECT NVL(MAX(ROWNUM),0)
		FROM board_cafe
		<!-- 
		parameter로 넘어오는 cafeDto의 값이 null 인지 아닌지 여부로 어떤 where 절을 실행할 지 동적으로 판단
		
		WHERE x
		WHERE title LIKE ? OR CONTENT LIKE ?
		WHERE title LIKE ?
		WHERE writer LIKE ?
		
		LIKE 문은 WHERE 절에서 = 문 과 같이 같다는 의미. but % 기능이 있다.
		%nayoon% 앞 뒤 문자 상관 없이 nayoon 이라는 문자열이 포함 되어 있는 문자열
		where 문에 이어 나오는 or는 mybatis가 자동 삭제해 줌. 
		oracle에서 || 는 문자열 이어붙이기 연산자 '%nayoon%" == '%'||'nayoon'||'%'
		 -->
		<where>
			<if test="writer != null">
				OR writer LIKE '%'||#{writer}||'%'
			</if>
			<if test="title != null">
				OR title LIKE '%'||#{title}||'%'
			</if>
			<if test="content != null">
				OR content LIKE '%'||#{content}||'%'
			</if>
		</where>
	</select>
	
	<select id="getList" parameterType="cafeDto" resultType="cafeDto">
	<!-- 검색하지 않은 경우 where문을 무시하고 다 페이징 처리 하지만, 검색 한 경우 해당 검색 내용만 select -->
		SELECT *
		FROM (SELECT result1.*,ROWNUM rnum
			FROM (SELECT <include refid="cafeColumn"/>
					FROM board_cafe
					<where>
						<if test="writer != null">
							OR writer LIKE '%'||#{writer}||'%'
						</if>
						<if test="title != null">
							OR title LIKE '%'||#{title}||'%'
						</if>
						<if test="content != null">
							OR content LIKE '%'||#{content}||'%'
						</if>
					</where>
					ORDER BY num DESC) result1
				)
		WHERE rnum BETWEEN #{startRowNum} AND #{endRowNum}
	</select>
	
	<select id="getData" parameterType="cafeDto" resultType="cafeDto">
		SELECT result1.*
		FROM (SELECT <include refid="cafeColumn"/>,
				LAG(num, 1, 0) OVER(ORDER BY num DESC) prevNum,
				LEAD(num, 1 ,0) OVER(ORDER BY num DESC) nextNum,
				LAG(title) OVER(ORDER BY num DESC) prevName,
				LEAD(title) OVER(ORDER BY num DESC) nextName
				FROM board_cafe
				<where> <!-- 검색 키워드에 맞는 이전 글 다음 글 정보 얻기 위함 -->
					<if test="writer != null">
						OR writer LIKE '%'||#{writer}||'%'
					</if>
					<if test="title != null">
						OR title LIKE '%'||#{title}||'%'
					</if>
					<if test="content != null">
						OR content LIKE '%'||#{content}||'%'
					</if>
				</where>
				ORDER BY num DESC) result1
		WHERE num=#{num}
	</select>
	
	<update id="addViewCount" parameterType="int">
		UPDATE board_cafe
		SET viewCount=viewCount+1
		WHERE num=#{num}
	</update>
</mapper>